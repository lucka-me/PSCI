(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{14:function(t,e,s){"use strict";var i=s(2);const n=Date.now();class a{constructor(){this.id="",this.title="",this.image="",this.status=i.c.codes.get(0),this.confirmedTime=0,this.confirmationMailId="",this.resultTime=null,this.resultMailId=null,this.lngLat=null}get imageUrl(){return"https://lh3.googleusercontent.com/"+this.image}get intelUrl(){return`https://intel.ingress.com/intel?ll=${this.lngLat.lat},${this.lngLat.lng}&z=18`}get bsUrl(){return"http://brainstorming.azurewebsites.net/watermeter.html#"+this.id}get restoreTime(){return this.confirmedTime+12096e5}get confirmedDateString(){return new Date(this.confirmedTime).toLocaleDateString()}get resultDateString(){return new Date(this.resultTime).toLocaleDateString()}get intervalString(){const t=this.resultTime?this.resultTime:n,e=Math.floor((t-this.confirmedTime)/864e5);return`${e} day${e>1?"s":""}`}get restoreIntervalString(){const t=Math.floor((this.restoreTime-n)/864e5);return`${t} day${t>1?"s":""}`}get json(){let t={id:this.id,title:this.title,image:this.image,status:this.status.code,confirmedTime:this.confirmedTime,confirmationMailId:this.confirmationMailId};return this.resultTime&&(t.resultTime=this.resultTime),this.resultMailId&&(t.resultMailId=this.resultMailId),this.lngLat&&(t.lngLat={lng:this.lngLat.lng,lat:this.lngLat.lat}),t}static from(t){const e=new a;return e.id=t.id,e.title=t.title,e.image=t.image,e.status=i.c.codes.get(t.status),e.confirmedTime=t.confirmedTime,e.confirmationMailId=t.confirmationMailId,t.resultTime&&(e.resultTime=t.resultTime),t.resultMailId&&(e.resultMailId=t.resultMailId),t.lngLat&&(e.lngLat={lng:t.lngLat.lng,lat:t.lngLat.lat}),e}static parseId(t){return t.replace(/[^a-zA-Z0-9]/g,"").slice(-10).toLowerCase()}}e.a=a},16:function(t,e,s){"use strict";var i=s(27),n=s(17);e.a=new class{constructor(){const t=document.URL.includes("lucka.moe");this.text=`${i.a}d${n.version}-${t?"lite":"full"}`,this.fullFeature=!t}}},18:function(t,e,s){"use strict";s.d(e,"a",(function(){return r}));var i=s(26),n=s.n(i),a=s(2),o=s(16);const r={quality:"Quality",description:"Description",cultural:"Cultural",uniqueness:"Uniqueness",safety:"Safety",location:"Location"};class l{constructor(){this.reference=null,this.data=new Map}init(){const t=n.a.initializeApp({databaseURL:"https://oprbrainstorming.firebaseio.com"});this.reference=t.database().ref("c/reviews/")}query(t,e,s){this.data.has(t)?e(this.data.get(t)):o.a.fullFeature?this.reference.child(t).once("value",i=>{const n=i.val();n?(this.data.set(t,n),e(n)):s()},t=>s()):s()}queryLngLat(t,e,s){this.query(t,t=>{e({lng:parseFloat(t.lng),lat:parseFloat(t.lat)})},s)}update(t,e){const s=[];for(const e of t)(e.status.code<1||!this.data.has(e.id))&&s.push(e.id);let i=s.length;const n=()=>{i--,i<1&&e()};for(const t of s)this.reference.child(t).once("value",e=>{const s=e.val();s?(this.data.set(t,s),n()):n()},t=>n())}clear(){this.data.clear()}analyse(t){const e={review:0,nomination:0,rate:new Map,reviewTimes:[],synch:{total:0,synched:0}},s=Object.keys(r);for(const t of s)e.rate.set(t,[]);const i=(t,s)=>{t[s]&&e.rate.get(s).push(parseInt(t[s]))};for(const n of t){if(!this.data.has(n.id))continue;const t=this.data.get(n.id),a=[];for(const o of Object.keys(t)){if(!o.startsWith("review"))continue;const r=t[o];if(!r.stars)continue;e.review+=1,a.push(r.stars);const c=r.JSON;for(const t of s)i(c,t);e.reviewTimes.push(r.Timestamp),n.status.code<1||(e.synch.total+=1,l.isSynched(r.stars,n.status.code)&&(e.synch.synched+=1))}a.length<1||(e.nomination+=1)}return e}static isSynched(t,e){const s=a.c.reasons;if("D"===t&&e===s.get("duplicated").code)return!0;const i=parseFloat(t);if(isNaN(i))return!1;const n=a.c.types;return i<3&&e===s.get("undeclared").code||(i>3&&e===n.get("accepted").code||i>3&&e===s.get("tooClose").code)}}e.b=l},2:function(t,e,s){"use strict";s.d(e,"b",(function(){return a})),s.d(e,"a",(function(){return o}));var i=s(17);class n{constructor(t,e,s,i){this.key=t,this.code=e,this.title=s,this.icon=i}}class a extends n{constructor(t,e,s,i,n){super(t,e,s,i),this.queries=n}}class o extends n{constructor(t,e,s,i,n,a){super(t,e,s,i),this.color=n,this.keywords=a}}e.c=new class{constructor(){this.version=i.version,this.types=new Map,this.reasons=new Map,this.codes=new Map;for(const t of i.types){const e=new a(t.key,t.code,t.title,t.icon,new Map(t.queries));this.types.set(t.key,e),this.codes.set(t.code,e)}for(const t of i.reasons){const e=new o(t.key,t.code,t.title,t.icon,t.color,new Map(t.keywords));this.reasons.set(t.key,e),this.codes.set(t.code,e)}}typeMatched(t,e){return e<101?t===e:t>100}getTypeByCode(t){return 0===t?"pending":1===t?"accepted":"rejected"}getReasonByCode(t){if(t<100)return null;for(const e of this.reasons.values())if(e.code===t)return e;return null}}},5:function(t,e,s){"use strict";var i=s(6),n=s.n(i),a=s(25),o=s.n(a);var r=new class{constructor(){this.events={authStatusChanged:t=>{},onerror:t=>{}}}init(){gapi.load("client:auth2",()=>this.initClient())}initClient(){gapi.client.init({apiKey:"AIzaSyCqIaS8UizqjWrIKm5zV3_S8EffCWjKR-A",clientId:"361295761775-qshg0f5buh495dhubp4v5bignk7i5dh1.apps.googleusercontent.com",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:["https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.appdata"].join(" ")}).then(()=>{gapi.auth2.getAuthInstance().isSignedIn.listen(this.events.authStatusChanged),this.events.authStatusChanged(this.signedIn)},this.events.onerror)}get signedIn(){return gapi.auth2.getAuthInstance().isSignedIn.get()}get accessToken(){return gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}signIn(){gapi.auth2.getAuthInstance().signIn()}signOut(){gapi.auth2.getAuthInstance().signOut()}},l=s(2),c=s(14);class h{static mail(t,e){const s=new c.a;s.status=l.c.types.get(e.type),"pending"===e.type?(s.confirmedTime=parseInt(t.internalDate),s.confirmationMailId=t.id):(s.resultTime=parseInt(t.internalDate),s.resultMailId=t.id);for(let e=0;e<t.payload.headers.length;e++){const i=t.payload.headers[e];if("Subject"===i.name){const t=i.value,e=t.search(":"),n=t.search("ï¼š");s.title=t.slice((n<0?e:e<0||n<e?n:e)+1).trim();break}}for(const i of t.payload.parts)if("1"===i.partId){const t=this.base64(i.body.data);let n=t.slice(t.search(/googleusercontent\.com/));for(const t of['"',"\n"]){const e=n.search(t);e>0&&(n=n.slice(0,e))}s.image=n.replace("googleusercontent.com/",""),s.id=c.a.parseId(s.image),"redacted"===e.scanner&&"pending"!==e.type&&(s.lngLat=this.lngLat(t)),"rejected"===e.type&&(s.status=this.reason(t,e.scanner));break}return s}static reason(t,e){const s=t.slice(0,t.search("-NianticOps")),i=l.c.reasons.get("undeclared");let n=i;for(const t of l.c.reasons.values()){for(const i of t.keywords.get(e))if(s.search(i)>-1){n=t;break}if(n!==i)break}return n}static lngLat(t){let e=t.slice(t.search("https://www.ingress.com/intel"));e=e.slice(0,e.search('">'));const s=e.slice(e.search("ll=")+3,e.search("&z=18")).split(",");return{lng:parseFloat(s[1]),lat:parseFloat(s[0])}}static base64(t){return unescape(decodeURIComponent(escape(window.atob(t.replace(/\-/g,"+").replace(/\_/g,"/")))))}}var u=class{constructor(){this.types=[],this.scanners=[],this.ignoreMailIdList=[],this.nominations=[],this.progress={list:0,total:0,finished:0},this.events={finished:()=>{},bufferUpdate:()=>{},progressUpdate:()=>{}};for(const t of l.c.types.keys())this.types.push(t);for(const t of l.c.types.get(this.types[0]).queries.keys())this.scanners.push(t)}start(t){this.nominations=t,this.progress.list=0,this.progress.total=0,this.progress.finished=0,this.ignoreMailIdList=[];for(const t of this.nominations)this.ignoreMailIdList.push(t.confirmationMailId),t.resultMailId&&this.ignoreMailIdList.push(t.resultMailId);for(const t of this.scanners)for(const e of this.types)this.query({scanner:t,type:e})}query(t){const e=[];this.getListRequest(null,t).execute(s=>{this.handleListRequest(s,t,e)})}getListRequest(t,e){return gapi.client.gmail.users.messages.list({userId:"me",q:l.c.types.get(e.type).queries.get(e.scanner),pageToken:t})}handleListRequest(t,e,s){if(t.result.messages&&s.push(...t.result.messages),t.result.nextPageToken){this.getListRequest(t.result.nextPageToken,e).execute(t=>{this.handleListRequest(t,e,s)})}else{for(let t=s.length-1;t>=0;t--)for(let e of this.ignoreMailIdList)if(s[t].id===e){s.splice(t,1);break}this.progress.list+=1,this.events.bufferUpdate(this.progress.list/this.scanners.length),this.processList(e,s)}}processList(t,e){this.progress.total+=e.length;const s=()=>{this.progress.list===this.scanners.length*this.types.length&&this.progress.total===this.progress.finished&&this.events.finished()};s();for(const i of e)gapi.client.gmail.users.messages.get({userId:"me",id:i.id,format:"full",metadataHeaders:"Subject"}).execute(e=>{this.nominations.push(h.mail(e.result,t)),this.progress.finished+=1,this.events.progressUpdate(this.progress.finished/this.progress.total*(this.progress.list/this.scanners.length)),s()})}},d=s(18);class g{}g.type="application/json",g.nominations="potori.json",g.bsData="bsdata.json";class p{constructor(){this.events={openUI:()=>{},saveUI:()=>{}}}open(t,e){this.events.openUI(s=>{const i=s.target.files[0];if(!i)return void e(n.a.t("message:Failed to open file"));const a=new FileReader;a.onload=()=>{t(a.result)},a.readAsText(i)})}save(t,e){this.events.saveUI(t,URL.createObjectURL(e))}}class m{constructor(){this.ids=new Map}static get folder(){return"appDataFolder"}get(t,e){const s=i=>{if(i.length<1)return void e(null,!1);const n=i[0].id;gapi.client.drive.files.get({fileId:n,alt:"media"}).then(a=>{if(!e(a.result,!0))return gapi.client.drive.files.delete({fileId:n}),i.splice(0,1),void s(i);this.ids.set(t,n)})};gapi.client.drive.files.list({q:`name = '${t}'`,pageSize:10,spaces:m.folder,fields:"files(id)"}).then(t=>{const i=t.result.files;i?s(i):e(null,!1)})}upload(t,e,s){let i="",n="";const a={name:t,mimeType:g.type};this.ids.has(t)?(n="PATCH",i=`https://www.googleapis.com/upload/drive/v3/files/${this.ids.get(t)}?uploadType=multipart`):(n="POST",i="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",a.parents=[m.folder]);const o=new FormData;o.append("metadata",new Blob([JSON.stringify(a)],{type:g.type})),o.append("file",e);const l="Bearer "+r.accessToken;fetch(i,{method:n,headers:new Headers({Authorization:l}),body:o}).then(t=>t.json()).then(e=>{e&&e.id&&this.ids.set(t,e.id),s(e)}).catch(()=>s(null))}}var f=class{constructor(){this.local=new p,this.googleDrive=new m}},v=s(28);class y{static nominations(t){const e={matched:!1,message:"",nominations:[]};try{const s=JSON.parse(t);if(0===s.length)return e.message=n.a.t("message:List is empty"),e;for(const t of s){if(!c.a.from(t).id)return e.nominations=[],e.message=n.a.t("message:Failed to parse as Nomination List"),e;e.nominations.push(c.a.from(t))}}catch(t){return e.message=n.a.t("message:Failed to parse as Nomination List"),e}return e.matched=!0,e}static bsData(t){const e={matched:!1,message:"",data:null};try{e.data=new Map(JSON.parse(t)),e.matched=!0}catch(t){e.message=n.a.t("message:Failed to parse as Brainstorming Data")}return e}}class w{static nominations(t){const e=[];for(const s of t)e.push(s.json);return new Blob([JSON.stringify(e,null,4)],{type:g.type})}static bsData(t){return new Blob([JSON.stringify([...t],null,4)],{type:g.type})}}e.a=new class{constructor(){this.auth=r,this.bs=new d.b,this.file=new f,this.mari=new u,this.nominations=[],this.events={authStatusChanged:t=>t,progressUpdate:t=>t,updateBs:()=>{},showProgress:()=>{},show:()=>{},clear:()=>{},alert:t=>t,info:t=>t}}init(){n.a.use(o.a).init({fallbackLng:"en-US",keySeparator:!1,resources:v.a,ns:["general","message"],defaultNS:"general"}),this.auth.events.authStatusChanged=t=>{t||(this.nominations=[]),this.events.authStatusChanged(t),t&&this.startMail()},this.auth.events.onerror=t=>{this.events.alert(JSON.stringify(t,null,2))},this.auth.init(),this.bs.init(),this.mari.events.finished=()=>this.finish()}startMail(){this.events.clear(),this.events.showProgress(),this.download(()=>{this.mari.start(this.nominations)})}finish(){this.events.showProgress();for(let t=this.nominations.length-1;t>=0;t--){const e=this.nominations[t];for(let s=0;s<t;s++){if(e.id!==this.nominations[s].id)continue;const i=this.nominations[s];i.resultMailId?(i.confirmedTime=e.confirmedTime,i.confirmationMailId=e.confirmationMailId,i.lngLat||(i.lngLat=e.lngLat)):(i.status=e.status,i.lngLat=e.lngLat,i.resultTime=e.resultTime,i.resultMailId=e.resultMailId),this.nominations.splice(t,1);break}}this.nominations.sort((t,e)=>(t.resultTime?t.resultTime:t.confirmedTime)<(e.resultTime?e.resultTime:e.confirmedTime)?1:-1);const t=()=>{this.events.show()},e=this.nominations.reduce((t,e)=>(e.lngLat||t.push(e),t),[]);if(e.length<1)return void t();let s=0;this.events.progressUpdate(.9);const i=()=>{s+=1,this.events.progressUpdate(.9+s/e.length*.1),s===e.length&&t()};for(const t of e)this.bs.queryLngLat(t.id,e=>{t.lngLat=e,i()},i)}open(){this.events.clear();this.file.local.open(t=>{const e=y.nominations(t);if(e.matched)return this.nominations=[],this.nominations.push(...e.nominations),void this.finish();const s=y.bsData(t);return s.matched?(this.bs.data=s.data,this.nominations.length>0&&this.events.updateBs(),void this.events.info(n.a.t("message:Load as Brainstorming Data"))):void 0},this.events.alert)}save(){this.nominations.length<1?this.events.alert(n.a.t("message:No Nomination to save")):(this.file.local.save(g.nominations,w.nominations(this.nominations)),window.setTimeout(()=>{this.file.local.save(g.bsData,w.bsData(this.bs.data))},2e3))}download(t){let e=!1,s=!1;const i=()=>{e&&s&&t()};this.file.googleDrive.get(g.bsData,(t,e)=>{if(!t)return s=!0,i(),!0;try{this.bs.data=new Map(t)}catch(t){return!e&&(s=!0,i(),!0)}return s=!0,i(),!0}),this.file.googleDrive.get(g.nominations,(t,s)=>{if(!t)return e=!0,i(),!0;try{const e=t;this.nominations=e.map(t=>c.a.from(t))}catch(t){return!s&&(e=!0,i(),!0)}return e=!0,i(),!0})}upload(){let t=!1,e=!1;const s=()=>{t&&e&&this.events.info(n.a.t("message:Uploaded"))};this.file.googleDrive.upload(g.nominations,w.nominations(this.nominations),e=>{if(t=!0,e){if(!e.id)return void this.events.alert(`${n.a.t("message:Unable to upload Nomination List")}\n${e.message}`)}else this.events.alert(n.a.t("message:Unable to upload Nomination List"));s()}),this.file.googleDrive.upload(g.bsData,w.bsData(this.bs.data),t=>{if(e=!0,t){if(!t.id)return void this.events.alert(`${n.a.t("message:Unable to upload Brainstorming Data")}\n${t.message}`)}else this.events.alert(n.a.t("message:Unable to upload Brainstorming Data"));s()})}import(t){let e;try{e=JSON.parse(t)}catch(t){return void this.events.alert(n.a.t("message:Unable to parse the code"))}(!e.result||e.result.length<1)&&this.events.alert(n.a.t("message:Invalid data"));const s=new Map;for(const t of this.nominations)s.set(t.id,t);for(const t of e.result){const e=t.imageUrl.replace("https://lh3.googleusercontent.com/",""),i=c.a.parseId(e);if(!s.has(i))continue;const n=s.get(i);n.title=t.title,n.lngLat={lng:parseFloat(t.lng),lat:parseFloat(t.lat)}}this.events.show()}updateBsData(){this.bs.update(this.nominations,()=>{this.events.updateBs(),this.events.info(n.a.t("message:Brainstorming Data updated"))})}clearBsData(){this.bs.clear()}}}}]);