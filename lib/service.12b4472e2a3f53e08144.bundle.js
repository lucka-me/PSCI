(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{0:function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var i=s(3),n=s(31);class a{constructor(){this.events={authStatusChanged:()=>{},error:()=>{}}}init(){navigator.onLine&&gapi.load("client:auth2",(()=>this.initClient()))}initClient(){gapi.client.init({apiKey:"AIzaSyCqIaS8UizqjWrIKm5zV3_S8EffCWjKR-A",clientId:"361295761775-qshg0f5buh495dhubp4v5bignk7i5dh1.apps.googleusercontent.com",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:["https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.appdata"].join(" ")}).then((()=>{gapi.auth2.getAuthInstance().isSignedIn.listen(this.events.authStatusChanged),this.events.authStatusChanged(this.signedIn)}),this.events.error)}get signedIn(){return navigator.onLine&&gapi.auth2.getAuthInstance().isSignedIn.get()}get accessToken(){return gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}signIn(){gapi.auth2.getAuthInstance().signIn()}signOut(){gapi.auth2.getAuthInstance().signOut()}}class r{}r.type="application/json",r.nominations="potori.json",r.bsData="bsdata.json";class o{constructor(){this.ids=new Map}download(e,t){const s=i=>{if(i.length<1)return void t(null,!1);const n=i[0].id;gapi.client.drive.files.get({fileId:n,alt:"media"}).then((a=>{if(!t(a.result,!0))return gapi.client.drive.files.delete({fileId:n}),i.splice(0,1),void s(i);this.ids.set(e,n)}))};gapi.client.drive.files.list({q:`name = '${e}'`,pageSize:10,spaces:o.folder,fields:"files(id)"}).then((e=>{const i=e.result.files;i?s(i):t(null,!1)}))}upload(e,t,s,i){let n="",a="";const l={name:e,mimeType:r.type};this.ids.has(e)?(a="PATCH",n=`https://www.googleapis.com/upload/drive/v3/files/${this.ids.get(e)}?uploadType=multipart`):(a="POST",n="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",l.parents=[o.folder]);const c=new FormData;c.append("metadata",new Blob([JSON.stringify(l)],{type:r.type})),c.append("file",t);fetch(n,{method:a,headers:new Headers({Authorization:"Bearer "+s}),body:c}).then((e=>e.json())).then((t=>{t&&t.id?(this.ids.set(e,t.id),i(!0)):i(!1,t.message)})).catch((()=>i(!1)))}}o.folder="appDataFolder";class l{constructor(){this.events={openUI:()=>{},saveUI:()=>{}}}open(e,t){this.events.openUI((s=>{if(!s)return void t(i.a.t("message:service.file.local.openFailed"));const n=new FileReader;n.onload=()=>{e(n.result)},n.readAsText(s)}))}save(e,t){this.events.saveUI(e,URL.createObjectURL(t))}}class c{constructor(){this.local=new l,this.googleDrive=new o}}const d="service.nomination",u={day:d+".day",missing:d+".missing",messageParseErrorMissingId:`message:${d}.parseErrorMissingId`,messageParseErrorMissingTitle:`message:${d}.parseErrorMissingTitle`,messageParseErrorMissingImage:`message:${d}.parseErrorMissingImage`,messageParseErrorInvalidId:`message:${d}.parseErrorInvalidId`,messageParseErrorInvalidImage:`message:${d}.parseErrorInvalidImage`},g=Date.now();class h{constructor(){this.id="",this.title="",this.image="",this.status=null,this.confirmedTime=0,this.confirmationMailId="",this.resultTime=null,this.resultMailId=null,this.lngLat=null}get imageUrl(){return"https://lh3.googleusercontent.com/"+this.image}get intelUrl(){return`https://intel.ingress.com/intel?ll=${this.lngLat.lat},${this.lngLat.lng}&z=18`}get bsUrl(){return"https://brainstorming.azurewebsites.net/watermeter.html#"+this.id}get restoreTime(){return this.confirmedTime+12096e5}get confirmedDateString(){return this.confirmedTime>0?new Date(this.confirmedTime).toLocaleDateString():i.a.t(u.missing)}get resultDateString(){return new Date(this.resultTime).toLocaleDateString()}get intervalString(){const e=this.resultTime?this.resultTime:g;return i.a.t(u.day,{count:Math.floor((e-this.confirmedTime)/864e5)})}get restoreIntervalString(){return i.a.t(u.day,{count:Math.floor((this.restoreTime-g)/864e5)})}get json(){let e={id:this.id,title:this.title,image:this.image,status:this.status.code,confirmedTime:this.confirmedTime,confirmationMailId:this.confirmationMailId};return this.resultTime&&(e.resultTime=this.resultTime),this.resultMailId&&(e.resultMailId=this.resultMailId),this.lngLat&&(e.lngLat={lng:this.lngLat.lng,lat:this.lngLat.lat}),e}static parse(e){if(!e.id)throw new Error(u.messageParseErrorMissingId);if(!e.title)throw new Error(u.messageParseErrorMissingTitle);if(!e.image)throw new Error(u.messageParseErrorMissingImage);const t=e.image.replace("\r","");if(!/^[a-zA-Z0-9]+$/.test(e.id))throw new Error(u.messageParseErrorInvalidId);if(!/^[0-9a-zA-Z\-\_]+$/.test(t))throw new Error(u.messageParseErrorInvalidImage);const s=new h;return s.id=e.id,s.title=e.title,s.image=t,s.status=y.status.codes.get(e.status),s.confirmedTime=e.confirmedTime,s.confirmationMailId=e.confirmationMailId,e.resultTime&&(s.resultTime=e.resultTime),e.resultMailId&&(s.resultMailId=e.resultMailId),e.lngLat&&(s.lngLat={lng:e.lngLat.lng,lat:e.lngLat.lat}),s}static parseId(e){return e.replace(/[^a-zA-Z0-9]/g,"").slice(-10).toLowerCase()}}class m{static nominations(e){const t={matched:!1,message:"",nominations:[]};try{const s=JSON.parse(e);if(0===s.length)return t.message=i.a.t("message:service.parseEmpty"),t;for(const e of s){const s=h.parse(e);t.nominations.push(s)}t.matched=!0}catch(e){t.nominations=[],t.matched=!1,t.message=i.a.t("message:service.parseNominationsFailed")}return t}static bsData(e){const t={matched:!1,message:"",data:null};try{t.data=new Map(JSON.parse(e)),t.matched=!0}catch(e){t.matched=!1,t.message=i.a.t("message:service.parseBsDataFailed")}return t}}class p{static nominations(e){const t=[];for(const s of e)t.push(s.json);return new Blob([JSON.stringify(t,null,4)],{type:r.type})}static bsData(e){return new Blob([JSON.stringify([...e],null,4)],{type:r.type})}}var f=s(19);class v{static mail(e,t){const s=new h;s.status=y.status.types.get(t.type),"pending"===t.type?(s.confirmedTime=parseInt(e.internalDate),s.confirmationMailId=e.id):(s.resultTime=parseInt(e.internalDate),s.resultMailId=e.id);for(let t=0;t<e.payload.headers.length;t++){const i=e.payload.headers[t];if("Subject"===i.name){const e=i.value,t=e.search(":"),n=e.search("ï¼š");s.title=e.slice((n<0?t:t<0||n<t?n:t)+1).trim();break}}for(const i of e.payload.parts){if("1"!==i.partId)continue;const e=this.base64(i.body.data),n=e.match(/googleusercontent\.com\/[0-9a-zA-Z\-\_]+/);n&&(s.image=n[0].replace("googleusercontent.com/",""),s.id=h.parseId(s.image)),"redacted"===t.scanner&&"pending"!==t.type&&(s.lngLat=this.lngLat(e)),"rejected"===t.type&&(s.status=this.reason(e,t.scanner));break}return s}static reason(e,t){const s=e.slice(0,e.search("-NianticOps"));let i=y.status.reasons.get("undeclared"),n=e.length;for(const e of y.status.reasons.values())for(const a of e.keywords.get(t)){const t=s.search(a);if(t>-1&&t<n){i=e,n=t;break}}return i}static lngLat(e){let t=e.slice(e.search("https://www.ingress.com/intel"));t=t.slice(0,t.search('">'));const s=t.slice(t.search("ll=")+3,t.search("&z=18")).split(",");return{lng:parseFloat(s[1]),lat:parseFloat(s[0])}}static base64(e){return unescape(decodeURIComponent(escape(window.atob(e.replace(/\-/g,"+").replace(/\_/g,"/")))))}}class w{constructor(){this.scanners=[],this.types=[],this.ignoreMailIds=[],this.nominations=[],this.progress={list:0,total:0,finished:0},this.events={alert:()=>{},finish:()=>{},buffer:()=>{},progress:()=>{}}}init(){for(const e of y.status.types.keys())this.types.push(e);for(const e of y.status.types.get(this.types[0]).queries.keys())this.scanners.push(e)}start(e){this.nominations=e,this.progress.list=0,this.progress.total=0,this.progress.finished=0,this.ignoreMailIds=[];for(const e of this.nominations)this.ignoreMailIds.push(e.confirmationMailId),e.resultMailId&&this.ignoreMailIds.push(e.resultMailId);for(const e of this.scanners)for(const t of this.types){const s={scanner:e,type:t};w.getListRequest(null,s).execute((e=>{this.handleListRequest(e,s,[])}))}}static getListRequest(e,t){return gapi.client.gmail.users.messages.list({userId:"me",q:y.status.types.get(t.type).queries.get(t.scanner),pageToken:e})}handleListRequest(e,t,s){if(e.result.messages&&s.push(...e.result.messages),e.result.nextPageToken){w.getListRequest(e.result.nextPageToken,t).execute((e=>{this.handleListRequest(e,t,s)}))}else{for(let e=s.length-1;e>=0;e--)for(const t of this.ignoreMailIds)if(s[e].id===t){s.splice(e,1);break}this.progress.list+=1,this.events.buffer(this.progress.list/this.scanners.length),this.processList(t,s)}}processList(e,t){this.progress.total+=t.length;const s=()=>{this.progress.list===this.scanners.length*this.types.length&&this.progress.total===this.progress.finished&&this.events.finish()};s();for(const n of t)gapi.client.gmail.users.messages.get({userId:"me",id:n.id,format:"full",metadataHeaders:"Subject"}).execute((t=>{const n=t.result;try{const t=v.mail(n,e);this.nominations.push(t)}catch(t){let s="";for(let e=0;e<n.payload.headers.length;e++){const t=n.payload.headers[e];if("Subject"===t.name){s=t.value;break}}let a=t;if("message"in t){const e=t;a=e.stack||e.message}this.events.alert(i.a.t("message:service.mari.reportParserError",{subject:s,message:`[${e.scanner}:${e.type}]${a}`}))}this.progress.finished+=1,this.events.progress(this.progress.finished/this.progress.total*(this.progress.list/this.scanners.length)),s()}))}}var y,I=s(13),b=s(20),T=s(29),M=s(11);class L{constructor(){const e=document.URL.includes("lucka.moe");this.string=`${T.a}d${M.version}-${e?"lite":"full"}`,this.full=!e}}!function(e){function t(){e.events.start();const t=[],i=[];for(let s=e.nominations.length-1;s>=0;s--){const n=e.nominations[s];if(n.id.length<1){t.push({target:n,candidates:[]}),e.nominations.splice(s,1);continue}let a=0===n.status.code;for(let t=0;t<s;t++){const i=e.nominations[t];if(n.id===i.id){i.resultMailId?(i.confirmedTime=n.confirmedTime,i.confirmationMailId=n.confirmationMailId,i.lngLat||(i.lngLat=n.lngLat)):(i.status=n.status,i.lngLat=n.lngLat,i.resultTime=n.resultTime,i.resultMailId=n.resultMailId),e.nominations.splice(s,1),a=!0;break}}a&&i.push(n)}for(const e of t)for(const t of i)e.target.title===t.title&&(e.target.resultTime<t.confirmedTime||e.candidates.push(t));s(t)}function s(t){if(t.length<1)return e.nominations.sort(((e,t)=>(e.resultTime?e.resultTime:e.confirmedTime)<(t.resultTime?t.resultTime:t.confirmedTime)?1:-1)),void function(){const t=()=>{e.events.idle()},s=e.nominations.reduce(((e,t)=>(t.lngLat||e.push(t),e)),new Array);if(s.length<1)return void t();let i=0;e.events.progressUpdate(.9);const n=()=>{i+=1,e.events.progressUpdate(.9+i/s.length*.1),i===s.length&&t()};for(const t of s)e.bs.queryLocation(t,(e=>{t.lngLat=e,n()}),n)}();const i=t[0];if(i.candidates.length<1)return t.shift(),void s(t);const n=i.candidates[0];e.events.match(i.target,n,(e=>{if(e){n.status=i.target.status,n.resultTime=i.target.resultTime,n.resultMailId=i.target.resultMailId,t.shift();for(const e of t){const t=e.candidates.indexOf(n);t<0||e.candidates.splice(t,1)}}else i.candidates.shift();s(t)}))}e.auth=new a,e.bs=new f.b,e.file=new c,e.mari=new w,e.status=new I.c,e.version=new L,e.nominations=[],e.errors=[],e.events={authStatusChanged:()=>{},progressUpdate:()=>{},bufferUpdate:()=>{},bsUpdate:()=>{},start:()=>{},idle:()=>{},clear:()=>{},match:()=>{},alert:()=>{},info:()=>{}},e.init=function(){"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/sw.js")})),i.a.use(n.a).init({fallbackLng:"en-US",keySeparator:!1,resources:b.a,ns:["general","message"],defaultNS:"general"}),e.auth.events.authStatusChanged=t=>{t||(e.nominations.length=0),e.events.authStatusChanged(t),t&&(e.events.clear(),e.events.start(),function(t){let s=!1,i=!1;const n=()=>{s&&i&&t()};e.file.googleDrive.download(r.bsData,((t,s)=>{if(!t)return i=!0,n(),!0;try{e.bs.data=new Map(t)}catch(e){return!s&&(i=!0,n(),!0)}return i=!0,n(),!0})),e.file.googleDrive.download(r.nominations,((t,i)=>{if(!t)return s=!0,n(),!0;try{const s=t;e.nominations.length=0;for(const t of s)try{e.nominations.push(h.parse(t))}catch(e){}}catch(e){return!i&&(s=!0,n(),!0)}return s=!0,n(),!0}))}((()=>{e.mari.start(e.nominations)})))},e.auth.events.error=t=>{e.events.alert(JSON.stringify(t,null,2))},e.auth.init(),e.mari.events.alert=t=>e.events.alert(t),e.mari.events.progress=t=>e.events.progressUpdate(.9*t),e.mari.events.buffer=t=>e.events.bufferUpdate(t),e.mari.events.finish=()=>t(),e.mari.init(),window.addEventListener("error",(t=>{e.errors.push(t)}))},e.open=function(){e.events.clear(),e.file.local.open((s=>{const n=m.nominations(s);if(n.matched)return e.nominations.length=0,e.nominations.push(...n.nominations),void t();const a=m.bsData(s);return a.matched?(e.bs.data=a.data,e.nominations.length>0&&e.events.bsUpdate(),void e.events.info(i.a.t("message:service.loadBsData"))):void 0}),e.events.alert)},e.save=function(){e.nominations.length<1?e.events.alert(i.a.t("message:service.nominationsEmpty")):(e.file.local.save(r.nominations,p.nominations(e.nominations)),window.setTimeout((()=>{e.file.local.save(r.bsData,p.bsData(e.bs.data))}),2e3))},e.upload=function(){let t=!1,s=!1;const n=()=>{t&&s&&e.events.info(i.a.t("message:service.uploaded"))};e.file.googleDrive.upload(r.nominations,p.nominations(e.nominations),e.auth.accessToken,((s,a)=>{t=!0,s||e.events.alert(`${i.a.t("message:service.uploadNominationsError")}${a?"\n"+a:""}`),n()})),e.file.googleDrive.upload(r.bsData,p.bsData(e.bs.data),e.auth.accessToken,((t,a)=>{s=!0,t||e.events.alert(`${i.a.t("message:service.uploadBsDataError")}${a?"\n"+a:""}`),n()}))},e.importJSON=function(t){let s;try{s=JSON.parse(t)}catch(t){return void e.events.alert(i.a.t("message:service.parseError"))}if(!s.result||s.result.length<1)return void e.events.alert(i.a.t("message:service.invalidData"));const n=new Map;for(const t of e.nominations)n.set(t.id,t);let a=0;for(const e of s.result){const t=e.imageUrl.replace("https://lh3.googleusercontent.com/",""),s=h.parseId(t);if(!n.has(s))continue;const i=n.get(s);i.title=e.title,i.lngLat={lng:parseFloat(e.lng),lat:parseFloat(e.lat)},a+=1}e.events.info(i.a.t("message:service.imported",{count:a})),e.events.idle()},e.updateBsData=function(){e.bs.update(e.nominations,(()=>{e.events.bsUpdate(),e.events.info(i.a.t("message:service.bsDataUpdated"))}))},e.clearBsData=function(){e.bs.clear()}}(y||(y={}))},13:function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return o}));var i=s(11);class n{constructor(e,t,s,i){this.key=e,this.code=t,this.title=s,this.icon=i}get type(){return 0===this.code?"pending":1===this.code?"accepted":"rejected"}isType(e){return e<101?this.code===e:this.code>100}}class a extends n{constructor(e,t,s,i,n){super(e,t,s,i),this.queries=n}}class r extends n{constructor(e,t,s,i,n,a){super(e,t,s,i),this.color=n,this.keywords=a}}class o{constructor(){this.version=i.version,this.types=new Map,this.reasons=new Map,this.codes=new Map;for(const e of i.types){const t=new a(e.key,e.code,e.title,e.icon,new Map(e.queries));this.types.set(e.key,t),this.codes.set(e.code,t)}for(const e of i.reasons){const t=new r(e.key,e.code,e.title,e.icon,e.color,new Map(e.keywords));this.reasons.set(e.key,t),this.codes.set(e.code,t)}}}},19:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i,n=s(0);!function(e){e.FIREBASE_ERROR="message:service.brainstorming.firebaseError",e.NOT_EXISTS="message:service.brainstorming.notExists",e.EARLY="message:service.brainstorming.early"}(i||(i={}));const a={quality:"service.brainstorming.quality",description:"service.brainstorming.description",cultural:"service.brainstorming.cultural",uniqueness:"service.brainstorming.uniqueness",safety:"service.brainstorming.safety",location:"service.brainstorming.location"};class r{constructor(){this.data=new Map,this.reference=null}query(e,t,s){this.beforeCreate(e)?s(i.EARLY):this.data.has(e.id)?t(this.data.get(e.id)):n.a.version.full?this.queryFirebase(e,t,s):s(i.NOT_EXISTS)}queryLocation(e,t,s){this.query(e,(e=>{t({lng:parseFloat(e.lng),lat:parseFloat(e.lat)})}),s)}update(e,t){const s=[];for(const t of e)this.beforeCreate(t)||s.push(t);let i=s.length;const n=()=>{i--,i<1&&t()};for(const e of s)this.queryFirebase(e,(t=>{this.data.set(e.id,t),n()}),n)}queryFirebase(e,t,n){this.beforeCreate(e)?n(i.EARLY):Promise.all([s.e(0).then(s.bind(null,58)),s.e(0).then(s.bind(null,64))]).then((([s,a])=>{if(!this.reference){const e=s.default.initializeApp({databaseURL:"https://oprbrainstorming.firebaseio.com"});this.reference||(this.reference=e.database().ref("c/reviews/"))}this.reference.child(e.id).once("value",(e=>{const s=e.val();s?t(s):n(i.NOT_EXISTS)}),(()=>n(i.FIREBASE_ERROR)))}))}clear(){this.data.clear()}beforeCreate(e){return e.status.code>0&&e.resultTime<15187968e5}analyse(e){const t={review:0,nomination:0,rate:new Map,reviewTimes:[],synch:{total:0,synched:0}},s=Object.keys(a);for(const e of s)t.rate.set(e,[]);const i=(e,s)=>{e[s]&&t.rate.get(s).push(parseInt(e[s]))};for(const n of e){if(!this.data.has(n.id))continue;const e=this.data.get(n.id),a=[];for(const o of Object.keys(e)){if(!o.startsWith("review"))continue;const l=e[o];if(!l.stars)continue;t.review+=1,a.push(l.stars);const c=l.JSON;for(const e of s)i(c,e);t.reviewTimes.push(l.Timestamp),n.status.code<1||(t.synch.total+=1,r.isSynched(l.stars,n.status.code)&&(t.synch.synched+=1))}a.length<1||(t.nomination+=1)}return t}static isSynched(e,t){const s=n.a.status.reasons;if("D"===e&&t===s.get("duplicated").code)return!0;const i=parseFloat(e);if(isNaN(i))return!1;if(t===n.a.status.types.get("accepted").code||t===s.get("close").code){if(i>=3)return!0}else if(i<3)return!0;return!1}}t.b=r}}]);