(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{0:function(t,e,s){"use strict";s.d(e,"a",(function(){return v}));var n=s(3),i=s(19);class a{constructor(){this.events={authStatusChanged:()=>{},error:()=>{}}}init(){navigator.onLine&&gapi.load("client:auth2",()=>this.initClient())}initClient(){gapi.client.init({apiKey:"AIzaSyCqIaS8UizqjWrIKm5zV3_S8EffCWjKR-A",clientId:"361295761775-qshg0f5buh495dhubp4v5bignk7i5dh1.apps.googleusercontent.com",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:["https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.appdata"].join(" ")}).then(()=>{gapi.auth2.getAuthInstance().isSignedIn.listen(this.events.authStatusChanged),this.events.authStatusChanged(this.signedIn)},this.events.error)}get signedIn(){return navigator.onLine&&gapi.auth2.getAuthInstance().isSignedIn.get()}get accessToken(){return gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}signIn(){gapi.auth2.getAuthInstance().signIn()}signOut(){gapi.auth2.getAuthInstance().signOut()}}class o{}o.type="application/json",o.nominations="potori.json",o.bsData="bsdata.json";class r{constructor(){this.ids=new Map}download(t,e){const s=n=>{if(n.length<1)return void e(null,!1);const i=n[0].id;gapi.client.drive.files.get({fileId:i,alt:"media"}).then(a=>{if(!e(a.result,!0))return gapi.client.drive.files.delete({fileId:i}),n.splice(0,1),void s(n);this.ids.set(t,i)})};gapi.client.drive.files.list({q:`name = '${t}'`,pageSize:10,spaces:r.folder,fields:"files(id)"}).then(t=>{const n=t.result.files;n?s(n):e(null,!1)})}upload(t,e,s,n){let i="",a="";const l={name:t,mimeType:o.type};this.ids.has(t)?(a="PATCH",i=`https://www.googleapis.com/upload/drive/v3/files/${this.ids.get(t)}?uploadType=multipart`):(a="POST",i="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",l.parents=[r.folder]);const c=new FormData;c.append("metadata",new Blob([JSON.stringify(l)],{type:o.type})),c.append("file",e);fetch(i,{method:a,headers:new Headers({Authorization:"Bearer "+s}),body:c}).then(t=>t.json()).then(e=>{e&&e.id?(this.ids.set(t,e.id),n(!0)):n(!1,e.message)}).catch(()=>n(!1))}}r.folder="appDataFolder";class l{constructor(){this.events={openUI:()=>{},saveUI:()=>{}}}open(t,e){this.events.openUI(s=>{if(!s)return void e(n.a.t("message:Failed to open file"));const i=new FileReader;i.onload=()=>{t(i.result)},i.readAsText(s)})}save(t,e){this.events.saveUI(t,URL.createObjectURL(e))}}class c{constructor(){this.local=new l,this.googleDrive=new r}}const u=Date.now();class h{constructor(){this.id="",this.title="",this.image="",this.status=null,this.confirmedTime=0,this.confirmationMailId="",this.resultTime=null,this.resultMailId=null,this.lngLat=null}get imageUrl(){return"https://lh3.googleusercontent.com/"+this.image}get intelUrl(){return`https://intel.ingress.com/intel?ll=${this.lngLat.lat},${this.lngLat.lng}&z=18`}get bsUrl(){return"https://brainstorming.azurewebsites.net/watermeter.html#"+this.id}get restoreTime(){return this.confirmedTime+12096e5}get confirmedDateString(){return new Date(this.confirmedTime).toLocaleDateString()}get resultDateString(){return new Date(this.resultTime).toLocaleDateString()}get intervalString(){const t=this.resultTime?this.resultTime:u;return n.a.t("dayCount",{count:Math.floor((t-this.confirmedTime)/864e5)})}get restoreIntervalString(){return n.a.t("dayCount",{count:Math.floor((this.restoreTime-u)/864e5)})}get json(){let t={id:this.id,title:this.title,image:this.image,status:this.status.code,confirmedTime:this.confirmedTime,confirmationMailId:this.confirmationMailId};return this.resultTime&&(t.resultTime=this.resultTime),this.resultMailId&&(t.resultMailId=this.resultMailId),this.lngLat&&(t.lngLat={lng:this.lngLat.lng,lat:this.lngLat.lat}),t}static from(t){const e=new h;return e.id=t.id,e.title=t.title,e.image=t.image,e.status=v.status.codes.get(t.status),e.confirmedTime=t.confirmedTime,e.confirmationMailId=t.confirmationMailId,t.resultTime&&(e.resultTime=t.resultTime),t.resultMailId&&(e.resultMailId=t.resultMailId),t.lngLat&&(e.lngLat={lng:t.lngLat.lng,lat:t.lngLat.lat}),e}static parseId(t){return t.replace(/[^a-zA-Z0-9]/g,"").slice(-10).toLowerCase()}}class d{static nominations(t){const e={matched:!1,message:"",nominations:[]};try{const s=JSON.parse(t);if(0===s.length)return e.message=n.a.t("message:List is empty"),e;for(const t of s){const s=h.from(t);if(!s.id)return e.nominations=[],e.message=n.a.t("message:Failed to parse as Nomination List"),e;e.nominations.push(s)}e.matched=!0}catch(t){e.matched=!1,e.message=n.a.t("message:Failed to parse as Nomination List")}return e}static bsData(t){const e={matched:!1,message:"",data:null};try{e.data=new Map(JSON.parse(t)),e.matched=!0}catch(t){e.matched=!1,e.message=n.a.t("message:Failed to parse as Brainstorming Data")}return e}}class g{static nominations(t){const e=[];for(const s of t)e.push(s.json);return new Blob([JSON.stringify(e,null,4)],{type:o.type})}static bsData(t){return new Blob([JSON.stringify([...t],null,4)],{type:o.type})}}var p=s(18);class m{static mail(t,e){const s=new h;s.status=v.status.types.get(e.type),"pending"===e.type?(s.confirmedTime=parseInt(t.internalDate),s.confirmationMailId=t.id):(s.resultTime=parseInt(t.internalDate),s.resultMailId=t.id);for(let e=0;e<t.payload.headers.length;e++){const n=t.payload.headers[e];if("Subject"===n.name){const t=n.value,e=t.search(":"),i=t.search("ï¼š");s.title=t.slice((i<0?e:e<0||i<e?i:e)+1).trim();break}}for(const n of t.payload.parts){if("1"!==n.partId)continue;const t=this.base64(n.body.data);s.image=t.match(/googleusercontent\.com\/[0-9a-zA-Z\-\_]+/)[0].replace("googleusercontent.com/",""),s.id=h.parseId(s.image),"redacted"===e.scanner&&"pending"!==e.type&&(s.lngLat=this.lngLat(t)),"rejected"===e.type&&(s.status=this.reason(t,e.scanner));break}return s}static reason(t,e){const s=t.slice(0,t.search("-NianticOps"));let n=v.status.reasons.get("undeclared"),i=t.length;for(const t of v.status.reasons.values())for(const a of t.keywords.get(e)){const e=s.search(a);if(e>-1&&e<i){n=t,i=e;break}}return n}static lngLat(t){let e=t.slice(t.search("https://www.ingress.com/intel"));e=e.slice(0,e.search('">'));const s=e.slice(e.search("ll=")+3,e.search("&z=18")).split(",");return{lng:parseFloat(s[1]),lat:parseFloat(s[0])}}static base64(t){return unescape(decodeURIComponent(escape(window.atob(t.replace(/\-/g,"+").replace(/\_/g,"/")))))}}class f{constructor(){this.types=[],this.scanners=[],this.ignoreMailIds=[],this.nominations=[],this.progress={list:0,total:0,finished:0},this.events={finish:()=>{},buffer:()=>{},progress:()=>{}}}init(){for(const t of v.status.types.keys())this.types.push(t);for(const t of v.status.types.get(this.types[0]).queries.keys())this.scanners.push(t)}start(t){this.nominations=t,this.progress.list=0,this.progress.total=0,this.progress.finished=0,this.ignoreMailIds=[];for(const t of this.nominations)this.ignoreMailIds.push(t.confirmationMailId),t.resultMailId&&this.ignoreMailIds.push(t.resultMailId);for(const t of this.scanners)for(const e of this.types)this.query({scanner:t,type:e})}static getListRequest(t,e){return gapi.client.gmail.users.messages.list({userId:"me",q:v.status.types.get(e.type).queries.get(e.scanner),pageToken:t})}query(t){const e=[];f.getListRequest(null,t).execute(s=>{this.handleListRequest(s,t,e)})}handleListRequest(t,e,s){if(t.result.messages&&s.push(...t.result.messages),t.result.nextPageToken){f.getListRequest(t.result.nextPageToken,e).execute(t=>{this.handleListRequest(t,e,s)})}else{for(let t=s.length-1;t>=0;t--)for(let e of this.ignoreMailIds)if(s[t].id===e){s.splice(t,1);break}this.progress.list+=1,this.events.buffer(this.progress.list/this.scanners.length),this.processList(e,s)}}processList(t,e){this.progress.total+=e.length;const s=()=>{this.progress.list===this.scanners.length*this.types.length&&this.progress.total===this.progress.finished&&this.events.finish()};s();for(const n of e)gapi.client.gmail.users.messages.get({userId:"me",id:n.id,format:"full",metadataHeaders:"Subject"}).execute(e=>{this.nominations.push(m.mail(e.result,t)),this.progress.finished+=1,this.events.progress(this.progress.finished/this.progress.total*(this.progress.list/this.scanners.length)),s()})}}var v,y=s(13),w=s(20),I=s(29),b=s(11);class T{constructor(){const t=document.URL.includes("lucka.moe");this.string=`${I.a}d${b.version}-${t?"lite":"full"}`,this.full=!t}}!function(t){function e(){t.events.start();for(let e=t.nominations.length-1;e>=0;e--){const s=t.nominations[e];for(let n=0;n<e;n++){if(s.id!==t.nominations[n].id)continue;const i=t.nominations[n];i.resultMailId?(i.confirmedTime=s.confirmedTime,i.confirmationMailId=s.confirmationMailId,i.lngLat||(i.lngLat=s.lngLat)):(i.status=s.status,i.lngLat=s.lngLat,i.resultTime=s.resultTime,i.resultMailId=s.resultMailId),t.nominations.splice(e,1);break}}t.nominations.sort((t,e)=>(t.resultTime?t.resultTime:t.confirmedTime)<(e.resultTime?e.resultTime:e.confirmedTime)?1:-1);const e=()=>{t.events.idle()},s=t.nominations.reduce((t,e)=>(e.lngLat||t.push(e),t),[]);if(s.length<1)return void e();let n=0;t.events.progressUpdate(.9);const i=()=>{n+=1,t.events.progressUpdate(.9+n/s.length*.1),n===s.length&&e()};for(const e of s)t.bs.queryLocation(e,t=>{e.lngLat=t,i()},i)}t.auth=new a,t.bs=new p.c,t.file=new c,t.mari=new f,t.status=new y.c,t.version=new T,t.nominations=[],t.events={authStatusChanged:()=>{},progressUpdate:()=>{},updateBs:()=>{},start:()=>{},idle:()=>{},clear:()=>{},alert:()=>{},info:()=>{}},t.init=function(){"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")}),n.a.use(i.a).init({fallbackLng:"en-US",keySeparator:!1,resources:w.a,ns:["general","message"],defaultNS:"general"}),t.auth.events.authStatusChanged=e=>{e||(t.nominations.length=0),t.events.authStatusChanged(e),e&&(t.events.clear(),t.events.start(),function(e){let s=!1,n=!1;const i=()=>{s&&n&&e()},a=(e,n)=>{if(!e)return s=!0,i(),!0;try{const s=e;t.nominations.length=0,t.nominations.push(...s.map(t=>h.from(t)))}catch(t){return!n&&(s=!0,i(),!0)}return s=!0,i(),!0},r=(e,s)=>{if(!e)return n=!0,i(),!0;try{t.bs.data=new Map(e)}catch(t){return!s&&(n=!0,i(),!0)}return n=!0,i(),!0};t.file.googleDrive.download(o.bsData,r),t.file.googleDrive.download(o.nominations,a)}(()=>{t.mari.start(t.nominations)}))},t.auth.events.error=e=>{t.events.alert(JSON.stringify(e,null,2))},t.auth.init(),t.mari.events.finish=()=>e(),t.mari.init()},t.open=function(){t.events.clear(),t.file.local.open(s=>{const i=d.nominations(s);if(i.matched)return t.nominations.length=0,t.nominations.push(...i.nominations),void e();const a=d.bsData(s);return a.matched?(t.bs.data=a.data,t.nominations.length>0&&t.events.updateBs(),void t.events.info(n.a.t("message:Load as Brainstorming Data"))):void 0},t.events.alert)},t.save=function(){t.nominations.length<1?t.events.alert(n.a.t("message:No Nomination to save")):(t.file.local.save(o.nominations,g.nominations(t.nominations)),window.setTimeout(()=>{t.file.local.save(o.bsData,g.bsData(t.bs.data))},2e3))},t.upload=function(){let e=!1,s=!1;const i=()=>{e&&s&&t.events.info(n.a.t("message:Uploaded"))};t.file.googleDrive.upload(o.nominations,g.nominations(t.nominations),t.auth.accessToken,(s,a)=>{e=!0,s||t.events.alert(`${n.a.t("message:Unable to upload Nomination List")}${a?"\n"+a:""}`),i()}),t.file.googleDrive.upload(o.bsData,g.bsData(t.bs.data),t.auth.accessToken,(e,a)=>{s=!0,e||t.events.alert(`${n.a.t("message:Unable to upload Brainstorming Data")}${a?"\n"+a:""}`),i()})},t.importJSON=function(e){let s;try{s=JSON.parse(e)}catch(e){return void t.events.alert(n.a.t("message:Unable to parse the code"))}(!s.result||s.result.length<1)&&t.events.alert(n.a.t("message:Invalid data"));const i=new Map;for(const e of t.nominations)i.set(e.id,e);for(const t of s.result){const e=t.imageUrl.replace("https://lh3.googleusercontent.com/",""),s=h.parseId(e);if(!i.has(s))continue;const n=i.get(s);n.title=t.title,n.lngLat={lng:parseFloat(t.lng),lat:parseFloat(t.lat)}}t.events.idle()},t.updateBsData=function(){t.bs.update(t.nominations,()=>{t.events.updateBs(),t.events.info(n.a.t("message:Brainstorming Data updated"))})},t.clearBsData=function(){t.bs.clear()}}(v||(v={}))},13:function(t,e,s){"use strict";s.d(e,"b",(function(){return a})),s.d(e,"a",(function(){return o})),s.d(e,"c",(function(){return r}));var n=s(11);class i{constructor(t,e,s,n){this.key=t,this.code=e,this.title=s,this.icon=n}}class a extends i{constructor(t,e,s,n,i){super(t,e,s,n),this.queries=i}}class o extends i{constructor(t,e,s,n,i,a){super(t,e,s,n),this.color=i,this.keywords=a}}class r{constructor(){this.version=n.version,this.types=new Map,this.reasons=new Map,this.codes=new Map;for(const t of n.types){const e=new a(t.key,t.code,t.title,t.icon,new Map(t.queries));this.types.set(t.key,e),this.codes.set(t.code,e)}for(const t of n.reasons){const e=new o(t.key,t.code,t.title,t.icon,t.color,new Map(t.keywords));this.reasons.set(t.key,e),this.codes.set(t.code,e)}}typeMatched(t,e){return e<101?t===e:t>100}getTypeByCode(t){return 0===t?"pending":1===t?"accepted":"rejected"}getReasonByCode(t){if(t<100)return null;for(const e of this.reasons.values())if(e.code===t)return e;return null}}},18:function(t,e,s){"use strict";s.d(e,"a",(function(){return n})),s.d(e,"b",(function(){return a}));var n,i=s(0);!function(t){t[t.FIREBASE_ERROR=0]="FIREBASE_ERROR",t[t.NOT_EXIST=1]="NOT_EXIST",t[t.EARLY=2]="EARLY"}(n||(n={}));const a={quality:"Quality",description:"Description",cultural:"Cultural",uniqueness:"Uniqueness",safety:"Safety",location:"Location"};class o{constructor(){this.data=new Map,this.reference=null}query(t,e,s){this.beforeCreate(t)?s(n.EARLY):this.data.has(t.id)?e(this.data.get(t.id)):i.a.version.full?this.queryFirebase(t,e,s):s(n.NOT_EXIST)}queryLocation(t,e,s){this.query(t,t=>{e({lng:parseFloat(t.lng),lat:parseFloat(t.lat)})},s)}update(t,e){const s=[];for(const e of t)this.beforeCreate(e)||s.push(e);let n=s.length;const i=()=>{n--,n<1&&e()};for(const t of s)this.queryFirebase(t,e=>{this.data.set(t.id,e),i()},i)}queryFirebase(t,e,i){this.beforeCreate(t)?i(n.EARLY):Promise.all([s.e(0).then(s.t.bind(null,57,7)),s.e(0).then(s.t.bind(null,83,7))]).then(([s,a])=>{if(!this.reference){const t=s.default.initializeApp({databaseURL:"https://oprbrainstorming.firebaseio.com"});this.reference||(this.reference=t.database().ref("c/reviews/"))}this.reference.child(t.id).once("value",t=>{const s=t.val();s?e(s):i(n.NOT_EXIST)},()=>i(n.FIREBASE_ERROR))})}clear(){this.data.clear()}beforeCreate(t){return t.status.code>0&&t.resultTime<1518796800}analyse(t){const e={review:0,nomination:0,rate:new Map,reviewTimes:[],synch:{total:0,synched:0}},s=Object.keys(a);for(const t of s)e.rate.set(t,[]);const n=(t,s)=>{t[s]&&e.rate.get(s).push(parseInt(t[s]))};for(const i of t){if(!this.data.has(i.id))continue;const t=this.data.get(i.id),a=[];for(const r of Object.keys(t)){if(!r.startsWith("review"))continue;const l=t[r];if(!l.stars)continue;e.review+=1,a.push(l.stars);const c=l.JSON;for(const t of s)n(c,t);e.reviewTimes.push(l.Timestamp),i.status.code<1||(e.synch.total+=1,o.isSynched(l.stars,i.status.code)&&(e.synch.synched+=1))}a.length<1||(e.nomination+=1)}return e}static isSynched(t,e){const s=i.a.status.reasons;if("D"===t&&e===s.get("duplicated").code)return!0;const n=parseFloat(t);if(isNaN(n))return!1;if(e===i.a.status.types.get("accepted").code||e===s.get("close").code){if(n>=3)return!0}else if(n<3)return!0;return!1}}e.c=o}}]);